name: E2E Tests

on: [ workflow_dispatch ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # End-to-end tests using WebdriverIO
  e2e-tests:
    name: e2e-tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v6

      - uses: awalsh128/cache-apt-pkgs-action@latest
        if: matrix.os == 'ubuntu-latest'
        with:
          packages: libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf xvfb
          version: "1.0"

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            .
            examples/tauri-app/src-tauri

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'examples/tauri-app/pnpm-lock.yaml'

      - name: Install frontend dependencies
        working-directory: examples/tauri-app
        run: pnpm install

      - name: Build Tauri app
        working-directory: examples/tauri-app
        run: pnpm tauri build --no-bundle

      - name: Run e2e tests (Linux)
        if: matrix.os == 'ubuntu-latest'
        working-directory: examples/tauri-app
        run: xvfb-run -a pnpm test:e2e

      - name: Run e2e tests (macOS)
        if: matrix.os == 'macos-latest'
        working-directory: examples/tauri-app
        run: pnpm test:e2e

      - name: Run e2e tests (Windows)
        if: matrix.os == 'windows-latest'
        working-directory: examples/tauri-app
        run: pnpm test:e2e

  # # Code coverage
  # coverage:
  #   name: code-coverage
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v6

  #     - uses: awalsh128/cache-apt-pkgs-action@latest
  #       with:
  #         packages: libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf xvfb
  #         version: "1.0"

  #     - uses: dtolnay/rust-toolchain@stable
  #       with:
  #         components: llvm-tools-preview

  #     - uses: Swatinem/rust-cache@v2
  #       with:
  #         workspaces: |
  #           .
  #           examples/tauri-app/src-tauri

  #     - uses: taiki-e/install-action@cargo-llvm-cov

  #     - uses: pnpm/action-setup@v4
  #       with:
  #         version: 9

  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: 22
  #         cache: 'pnpm'
  #         cache-dependency-path: 'examples/tauri-app/pnpm-lock.yaml'

  #     - name: Install frontend dependencies
  #       working-directory: examples/tauri-app
  #       run: pnpm install

  #     - name: Build frontend
  #       working-directory: examples/tauri-app
  #       run: pnpm build

  #     - name: Generate coverage report
  #       run: |
  #         cargo llvm-cov --all-features --workspace \
  #           --ignore-filename-regex='target/' \
  #           --lcov --output-path lcov.info

  #     - name: Upload coverage to Codecov
  #       uses: codecov/codecov-action@v4
  #       with:
  #         files: lcov.info
  #         fail_ci_if_error: false
  #         verbose: true
